---
title: "simul_results_analysis"
output: html_document
---

```{r}
library(IRanges)
library(GenomicRanges)
library(data.table)
library(stringr)
```

```{r}
load("method_set_list.Rdata")
load("simul_constructor_list.Rdata")
```

```{r add granges for simulated dmrs}
for(i in 1:length(simul_constructor_list)){
  simul <- simul_constructor_list[[i]]
  dmr_ids <- unique(simul$dmr_locs$dmr_name)
  temp <- data.frame(chr=character(length = length(dmr_ids)),
                     start=numeric(length = length(dmr_ids)),
                     end=numeric(length = length(dmr_ids)),
                     names=character(length = length(dmr_ids)))
  for(j in 1:length(dmr_ids)){
    which <- which(simul$dmr_locs$dmr_name==dmr_ids[j])
    temp$chr[j] <- as.character(unique(simul$dmr_locs$chr[which]))
    temp$start[j] <- min(simul$dmr_locs$pos[which])
    temp$end[j] <- max(simul$dmr_locs$pos[which])
    temp$names[j] <- dmr_ids[j]
  }
  
  simul_constructor_list[[i]]$grange <- GRanges(seqnames = temp$chr,
                                                ranges = IRanges(start=temp$start,
                                                                 end=temp$end,
                                                                 names=temp$names),
                                                strand = rep("*",nrow(temp)))
}

```

```{r add granges for called dmrs}
filenames <- list.files(path = "./results/simuls/", pattern = "*result.csv", full.names = T)

simul_results <- list()

for(simul_id in 1:length(simul_constructor_list)){
  for(method_id in 1:length(method_set_list)){
    filename <- filenames[grep(paste("simul_set_",simul_id,
                                     "__method_set_",method_id,
                                     sep=""), filenames)]
    result <- fread(filename)
    if(method_set_list[[method_id]]$method=="dmrscaler"){
      result <- result[grep("64",result$layer),]
    }
    simul_results[[basename(filename)]]$grange <- GRanges(
      seqnames = result$chr,
      ranges = IRanges(start = result$start,
                       end = result$stop,
                       pval_region = result$pval_region),
      strand = rep("*",nrow(result))
    ) 
    
  }
}

```

```{r width_pair setup}
WIDTH_PAIRS <- data.frame("method"=character(),
                          "delta_beta"=numeric(),
                          "noise"=numeric(),
                          "rep"=numeric(),
                          "simulated_width"=numeric(),
                          "called_width"=numeric())

for(i in 1:length(simul_results)){
  simul_id <- as.numeric(str_match(names(simul_results)[i],
                                   "simul_set_([0-9]*)")[2])
  simul <- simul_constructor_list[[simul_id]]
  method_id <- as.numeric(str_match(names(simul_results)[i],
                                    "method_set_([0-9]*)")[2])
  called_grs <- simul_results[[i]]$grange
  simul_grs <- simul$grange
  overlaps <- findOverlaps(simul_grs, called_grs)
  temp_df <- data.frame("method" = names(method_set_list)[method_id],
                        "delta_beta" = simul$pars$delta_beta,
                        "noise" = simul$pars$noise,
                        "rep" = simul$pars$rep,
                        "simulated_width" = simul_grs@ranges@width[overlaps@from],
                        "called_width" = called_grs@ranges@width[overlaps@to])
  WIDTH_PAIRS <- rbind(WIDTH_PAIRS, temp_df)
}

```

```{r mapping_value setup}
MAPPING_VALUES <- data.frame("method"=character(),
                          "delta_beta"=numeric(),
                          "noise"=numeric(),
                          "rep"=numeric(),
                          "mapping_value"=numeric())

for(i in 1:length(simul_results)){
  simul_id <- as.numeric(str_match(names(simul_results)[i],
                                   "simul_set_([0-9]*)")[2])
  simul <- simul_constructor_list[[simul_id]]
  method_id <- as.numeric(str_match(names(simul_results)[i],
                                    "method_set_([0-9]*)")[2])
  called_grs <- simul_results[[i]]$grange
  simul_grs <- simul$grange
  
  overlaps <- findOverlaps(simul_grs, called_grs)
  overlaps_count_simul <- countOverlaps( simul_grs, called_grs)
  overlaps_count_called <- countOverlaps( called_grs, simul_grs)
  
  count_called_per_simul <- numeric(length = length(simul_grs) )
  
  for(j in 1:length(simul_grs)){
    if(!is.element(j, overlaps@from)){ count_called_per_simul[j] <- 0; next;}
    which <- overlaps@to[which(overlaps@from==j)] 
    max_overlapping_those_called_over_sim <-max(overlaps_count_called[which])
    if(overlaps_count_simul[j] >= max_overlapping_those_called_over_sim){
      count_called_per_simul[j] <- overlaps_count_simul[j]
    } else { count_called_per_simul[j] <- 1/max_overlapping_those_called_over_sim}
  }
  
  
  temp_df <- data.frame("method" = names(method_set_list)[method_id],
                        "delta_beta" = simul$pars$delta_beta,
                        "noise" = simul$pars$noise,
                        "rep" = simul$pars$rep,
                        "mapping_value" = count_called_per_simul )
  MAPPING_VALUES <- rbind(MAPPING_VALUES, temp_df)
}

```

```{r}

```


