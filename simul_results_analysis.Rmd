---
title: "simul_results_analysis"
output: html_document
---

```{r}
library(IRanges)
library(GenomicRanges)
library(data.table)
library(stringr)
library(foreach)
library(doParallel)
registerDoParallel(detectCores())
library(ggplot2)
library(ggExtra)
```

```{r}
load("locs.Rdata")
load("method_set_list.Rdata")
load("simul_constructor_list.Rdata")
```

```{r add granges for locs and simulated dmrs}
locs_gr <- GRanges(seqnames=locs$chr, ranges = IRanges(start=locs$pos, width=1))

chr_seqlengths <- numeric(length=length(unique(locs$chr)))
names(chr_seqlengths) <- unique(locs$chr)
for(chr in unique(locs$chr)){
  chr_seqlengths[chr] <- max(locs$pos[which(locs$chr==chr)])+1
}
chr_seqinfo <- Seqinfo(names(chr_seqlengths), seqlengths = chr_seqlengths)

for(i in 1:length(simul_constructor_list)){
  simul <- simul_constructor_list[[i]]
  dmr_ids <- unique(simul$dmr_locs$dmr_name)
  temp <- data.frame(chr=character(length = length(dmr_ids)),
                     start=numeric(length = length(dmr_ids)),
                     end=numeric(length = length(dmr_ids)),
                     names=character(length = length(dmr_ids)))
  for(j in 1:length(dmr_ids)){
    which <- which(simul$dmr_locs$dmr_name==dmr_ids[j])
    temp$chr[j] <- as.character(unique(simul$dmr_locs$chr[which]))
    temp$start[j] <- min(simul$dmr_locs$pos[which])
    temp$end[j] <- max(simul$dmr_locs$pos[which])
    temp$names[j] <- dmr_ids[j]
  }
  
  simul_constructor_list[[i]]$grange <- GRanges(seqnames = temp$chr,
                                                ranges = IRanges(start=temp$start,
                                                                 end=temp$end,
                                                                 names=temp$names),
                                                strand = rep("*",nrow(temp)),
                                                seqinfo = chr_seqinfo)
}

```

```{r add granges for called dmrs}
filenames <- list.files(path = "./results/simuls/", pattern = "*result.csv", full.names = T)

simul_results <- list()

for(simul_id in 1:length(simul_constructor_list)){
  for(method_id in 1:length(method_set_list)){
    filename <- filenames[grep(paste("simul_set_",simul_id,
                                     "__method_set_",method_id,
                                     sep=""), filenames)]
    result <- fread(filename)
    if(method_set_list[[method_id]]$method=="dmrscaler"){
      result <- result[grep("64",result$layer),]
    }
    simul_results[[basename(filename)]]$grange <- GRanges(
      seqnames = result$chr,
      ranges = IRanges(start = result$start,
                       end = result$stop,
                       pval_region = result$pval_region),
      strand = rep("*",nrow(result)),
      seqinfo = chr_seqinfo
    )
    ### need to set a cutoff to region p-value for TP,FP, FN, etc
    which <- which(simul_results[[basename(filename)]]$grange$pval_region < 0.05)
    simul_results[[basename(filename)]]$grange <- simul_results[[basename(filename)]]$grange[which]
  }
}

```

```{r width_pair setup}
WIDTH_PAIRS <- data.frame("method"=character(),
                          "delta_beta"=numeric(),
                          "noise"=numeric(),
                          "rep"=numeric(),
                          "simulated_width"=numeric(),
                          "called_width"=numeric())

for(i in 1:length(simul_results)){
  simul_id <- as.numeric(str_match(names(simul_results)[i],
                                   "simul_set_([0-9]*)")[2])
  simul <- simul_constructor_list[[simul_id]]
  method_id <- as.numeric(str_match(names(simul_results)[i],
                                    "method_set_([0-9]*)")[2])
  called_grs <- simul_results[[i]]$grange
  simul_grs <- simul$grange
  overlaps <- findOverlaps(simul_grs, called_grs)
  
  temp_sw <- simul_grs@ranges@width[overlaps@from]
  if(length(temp_sw)==0){temp_sw <- NA}
  temp_cw <- called_grs@ranges@width[overlaps@to]
  if(length(temp_cw)==0){temp_cw <- NA}
  temp_df <- data.frame("method" = names(method_set_list)[method_id],
                        "delta_beta" = simul$pars$delta_beta,
                        "noise" = simul$pars$noise,
                        "rep" = simul$pars$rep,
                        "simulated_width" = temp_sw,
                        "called_width" = temp_cw
                        )
  WIDTH_PAIRS <- rbind(WIDTH_PAIRS, temp_df)
}

```

```{r mapping_value setup}
MAPPING_VALUES <- data.frame("method"=character(),
                          "delta_beta"=numeric(),
                          "noise"=numeric(),
                          "rep"=numeric(),
                          "mapping_value"=numeric())

for(i in 1:length(simul_results)){
  simul_id <- as.numeric(str_match(names(simul_results)[i],
                                   "simul_set_([0-9]*)")[2])
  simul <- simul_constructor_list[[simul_id]]
  method_id <- as.numeric(str_match(names(simul_results)[i],
                                    "method_set_([0-9]*)")[2])
  called_grs <- simul_results[[i]]$grange
  simul_grs <- simul$grange
  
  overlaps <- findOverlaps(simul_grs, called_grs)
  overlaps_count_simul <- countOverlaps( simul_grs, called_grs)
  overlaps_count_called <- countOverlaps( called_grs, simul_grs)
  
  count_called_per_simul <- numeric(length = length(simul_grs) )
  
  for(j in 1:length(simul_grs)){
    if(!is.element(j, overlaps@from)){ count_called_per_simul[j] <- 0; next;}
    which <- overlaps@to[which(overlaps@from==j)] 
    max_overlapping_those_called_over_sim <-max(overlaps_count_called[which])
    if(overlaps_count_simul[j] >= max_overlapping_those_called_over_sim){
      count_called_per_simul[j] <- overlaps_count_simul[j]
    } else { count_called_per_simul[j] <- 1/max_overlapping_those_called_over_sim}
  }
  
  
  temp_df <- data.frame("method" = names(method_set_list)[method_id],
                        "delta_beta" = simul$pars$delta_beta,
                        "noise" = simul$pars$noise,
                        "rep" = simul$pars$rep,
                        "mapping_value" = count_called_per_simul )
  MAPPING_VALUES <- rbind(MAPPING_VALUES, temp_df)
}

```

```{r auc_pr setup}

CALLED_TP_FP <- data.frame("method"=character(),
                          "delta_beta"=numeric(),
                          "noise"=numeric(),
                          "rep"=numeric(),
                          "TP"=numeric(),
                          "pval"=numeric())

CALLED_TP_FP <- foreach(i = 1:length(simul_results),
                        .combine = rbind,
                        .errorhandling = "pass" ) %dopar% {
  simul_id <- as.numeric(stringr::str_match(names(simul_results)[i],
                                   "simul_set_([0-9]*)")[2])
  simul <- simul_constructor_list[[simul_id]]
  method_id <- as.numeric(stringr::str_match(names(simul_results)[i],
                                    "method_set_([0-9]*)")[2])
  called_grs <- simul_results[[i]]$grange
  simul_grs <- simul$grange
  
  TP <- numeric(length = length(called_grs))
  cs_intersect <-  GenomicRanges::intersect( called_grs, simul_grs) 
  cs_overlap <- findOverlaps(called_grs, cs_intersect )
  for(j in 1:length(called_grs)){
    if(!is.element(j, cs_overlap@from)){ TP[j] <- 0;  next;}
    which<-cs_overlap@to[which(cs_overlap@from==j)]
    TP[j] <- sum(cs_intersect[which]@ranges@width) / called_grs[j]@ranges@width
  }  
  
  temp_pval <- called_grs@elementMetadata$pval_region
  if(length(temp_pval)==0){temp_pval <- NA}
  temp_df <- data.frame("method" = names(method_set_list)[method_id],
                        "delta_beta" = simul$pars$delta_beta,
                        "noise" = simul$pars$noise,
                        "rep" = simul$pars$rep,
                        "TP" = TP,
                        "pval" = temp_pval
                        )
  temp_df
}

```






```{r operating_statistics setup}
### want to measures and record global stats used in benchmark Mallik et al 2018
### create  table or supp table to report
### TP, FP, FN, Power, Precision, AuPR, MCC, F1, Time

### plots to make Precision-Recall,
###               Power-FDR,
###               Precision-Delta_Beta, Power-Delta_Beta
###               Precision-Noise, Power-Noise
###NOTE this foreach takes ~30-60 min on 12 cores-  save output and load instead of rerunning
if(file.exists("OPERATING_STATS.Rdata")){
  load("OPERATING_STATS.Rdata")
} else{
  temp_comb <- function(x, ...){
    mapply(rbind,x,...,SIMPLIFY = FALSE)
  }
  OPERATING_STATS <- foreach(i = 1:length(simul_results),
                             .combine = 'temp_comb',
                             .errorhandling = "pass" ) %dopar% {
    temp_colnames <- c("method","delta_beta","noise","rep",
                     "P", "N", ## positive count, negative count
                     "TP_called", "TP_simul", "TN"  ## 1 minus self: FP,FN,FP 
                     )
    OP_STATS <- list()
    OP_STATS[["feature"]] <- data.frame(matrix(NA, nrow=1,
                                       ncol=length(temp_colnames)) )
    OP_STATS[["basepair"]] <- data.frame(matrix(NA, nrow=1,
                                       ncol=length(temp_colnames)) )
    OP_STATS[["cpg_probe"]] <- data.frame(matrix(NA, nrow=1,
                                       ncol=length(temp_colnames)) )
  
    colnames(OP_STATS[["feature"]]) <- temp_colnames
    colnames(OP_STATS[["basepair"]]) <- temp_colnames
    colnames(OP_STATS[["cpg_probe"]]) <- temp_colnames
    
    
    
    simul_id <- as.numeric(str_match(names(simul_results)[i],
                                     "simul_set_([0-9]*)")[2])
    simul <- simul_constructor_list[[simul_id]]
    method_id <- as.numeric(str_match(names(simul_results)[i],
                                      "method_set_([0-9]*)")[2])
    
    called_grs <- simul_results[[i]]$grange
    simul_grs <- simul$grange
    ### need to set a cutoff to region p-value for TP,FP, FN, etc
    called_grs <- called_grs[which(called_grs$pval_region < 0.05)]
    
    for(j in 1:length(OP_STATS)){
      op_stat_type <- names(OP_STATS)
      OP_STATS[[j]]$method <-names(method_set_list)[method_id]
      OP_STATS[[j]]$delta_beta <- simul$pars$delta_beta
      OP_STATS[[j]]$noise <- simul$pars$noise
      OP_STATS[[j]]$rep <- simul$pars$rep
    }
    
    ## start : add TP rate to grs features ###
    cs_intersect <-  GenomicRanges::intersect( called_grs, simul_grs)
    cs_overlap <-  GenomicRanges::findOverlaps( called_grs, simul_grs)
    simul_inverse_grs <- gaps(simul_grs)
    simul_inverse_grs <- simul_inverse_grs[which(as.character(strand(simul_inverse_grs))=="*" )]
    cs_inverse_intersect <-  GenomicRanges::intersect( called_grs, simul_inverse_grs)
    cs_inverse_overlap <-  GenomicRanges::findOverlaps( called_grs, simul_inverse_grs)
    
    if(length(called_grs)==0){
      for(j in 1:length(OP_STATS)){
        OP_STATS[[j]]$TP_called <- 0
        OP_STATS[[j]]$TP_simul <- 0
      }
      OP_STATS$feature$P <- length(simul_grs)
      OP_STATS$feature$N <- length(simul_inverse_grs)
      OP_STATS$feature$TN <- 1
      OP_STATS$basepair$P <- sum(simul_grs@ranges@width)
      OP_STATS$basepair$N <- sum(simul_inverse_grs@ranges@width)
      OP_STATS$basepair$TN <- sum(simul_inverse_grs@ranges@width)
      OP_STATS$cpg_probe$P <- sum( GenomicRanges::countOverlaps(simul_grs, locs_gr) )
      OP_STATS$cpg_probe$N <- sum( GenomicRanges::countOverlaps(simul_inverse_grs, locs_gr) )
      OP_STATS$cpg_probe$TN <- sum( GenomicRanges::countOverlaps(simul_inverse_grs, locs_gr) )
    }else{
      simul_grs$TP <- -1
      for(j in 1:length(simul_grs)){
        if(!is.element(j, cs_overlap@to)){ simul_grs[j]$TP <- 0; next;}
        temp_gr <- GenomicRanges::intersect(cs_intersect, simul_grs[j])
        simul_grs[j]$TP <- sum(temp_gr@ranges@width) / simul_grs[j]@ranges@width 
      }
      simul_inverse_grs$TP <- -1
      for(j in 1:length(simul_inverse_grs)){
        if(!is.element(j, cs_inverse_overlap@to)){ simul_inverse_grs[j]$TP <- 1; next;}
        temp_gr <- GenomicRanges::intersect(cs_inverse_intersect, simul_inverse_grs[j])
        simul_inverse_grs[j]$TP <- 1-(sum(temp_gr@ranges@width) / simul_inverse_grs[j]@ranges@width)
      }
      called_grs$TP <- -1
      for(j in 1:length(called_grs)){
        if(!is.element(j, cs_overlap@from)){ called_grs[j]$TP <- 0; next;}
        temp_gr <- GenomicRanges::intersect(cs_intersect, called_grs[j])
        called_grs[j]$TP <- sum(temp_gr@ranges@width) / called_grs[j]@ranges@width 
      }
      ## end : add TP rate to grs features ###
      
      ## start: feature operating characteristics
      OP_STATS$feature$P <- length(simul_grs) 
      OP_STATS$feature$N <- length(simul_inverse_grs)
      OP_STATS$feature$TP_called <- mean(called_grs$TP)
      OP_STATS$feature$TP_simul <- mean(simul_grs$TP)
      OP_STATS$feature$TN <- mean(simul_inverse_grs$TP)
      ## end: feature operating characteristics
      ## start: basepair operating characteristics
      OP_STATS$basepair$P <- sum(simul_grs@ranges@width) 
      OP_STATS$basepair$N <- sum(simul_inverse_grs@ranges@width)
      OP_STATS$basepair$TP_called <- sum(called_grs$TP * called_grs@ranges@width)
      OP_STATS$basepair$TP_simul <- sum(simul_grs$TP * simul_grs@ranges@width)
      OP_STATS$basepair$TN <- sum(simul_inverse_grs@ranges@width) - sum(cs_inverse_intersect@ranges@width)
      ## end: basepair operating characteristics
      ## start: cpg_probe operating characteristics
      OP_STATS$cpg_probe$P <- sum( GenomicRanges::countOverlaps(simul_grs, locs_gr) ) 
      OP_STATS$cpg_probe$N <- sum( GenomicRanges::countOverlaps(simul_inverse_grs, locs_gr) )
      OP_STATS$cpg_probe$TP_called <- length(GenomicRanges::findOverlaps(locs_gr, cs_intersect)@from)
      OP_STATS$cpg_probe$TP_simul <- length(GenomicRanges::findOverlaps(locs_gr, cs_intersect)@from)
      temp <- length(GenomicRanges::findOverlaps(locs_gr, cs_inverse_intersect)@from)  
      OP_STATS$cpg_probe$TN <- (OP_STATS$cpg_probe$N - 
                                             length(GenomicRanges::findOverlaps(locs_gr, cs_inverse_intersect)@from))
    }
    write.csv(paste(simul_id, method_id, sep = ","),
              file=paste("temp_simul_method",simul_id, method_id,".csv",sep = "_") )
    
    OP_STATS
    ## end: cpg_probe operating characteristics
  }
  save(OPERATING_STATS, file="OPERATING_STATS.Rdata")
}
```


```{r simul_v_called widths plots}

GGPLOT_LIST <- list()
GGPLOT_LIST$ggl_width_pairs <- list()

for(method_id in 1:length(unique(WIDTH_PAIRS$method))){
  which <- which(WIDTH_PAIRS$method==unique(WIDTH_PAIRS$method)[method_id])
  gg_labels <- merge(data.frame(delta_beta=unique(WIDTH_PAIRS$delta_beta[which])),
                     data.frame(noise=unique(WIDTH_PAIRS$noise[which])))
  gg_labels$simulated_width <- Inf
  gg_labels$called_width <- Inf
  gg_labels$label <- as.character(c(1:nrow(gg_labels)))
  
  for(delta_beta in unique(WIDTH_PAIRS$delta_beta[which])){
    for(noise in unique(WIDTH_PAIRS$noise[which])){
      temp_which <- intersect(which, which(WIDTH_PAIRS$delta_beta==delta_beta &
                                             WIDTH_PAIRS$noise==noise))
      temp_index <- which(gg_labels$delta_beta==delta_beta & gg_labels$noise==noise)
      gg_labels$label[temp_index] <- paste("R = ",
                                           round(cor(log10(WIDTH_PAIRS$simulated_width[temp_which]),
                                                     log10(WIDTH_PAIRS$called_width[temp_which])),3 ),
                                           sep = "")
    }
  }
    
  

  gg <- ggplot(WIDTH_PAIRS[which,], aes(x=log10(simulated_width), y=log10(called_width))) +
    xlab("log10( Simulated DMR Width )")+
    ylab("log10( Called DMR Width )")+
    geom_abline(slope = 1, intercept = 0,size=0.2,alpha=0.6)+
    stat_density_2d(aes(fill= ..level..),geom = "polygon",  n=50, h=0.7, alpha=0.5) +
    geom_point(size=0.15, alpha=0.3)+
    scale_fill_gradient(low="grey70", high="grey20")+
    theme_bw()+
    theme(
      plot.background = element_blank(),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      text=element_text(face="bold", size=6),
      strip.text = element_text(face="bold", size=6, angle=0),
      axis.text = element_text(face="bold", size=6, angle=0),
      legend.position = "none"
    ) + facet_grid( delta_beta ~ noise) + geom_text(data = gg_labels, aes(label=label), x=4, y=6.5, size=3)
  
  facet_wrap(delta_beta ~ noise )
  gg
}




```

